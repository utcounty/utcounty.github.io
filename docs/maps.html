<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Maps – Utah County Political Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}
</style>


<link href="./images/favicon.ico" rel="icon">
<script src="https://cdn.tailwindcss.com"></script>



<script>

  tailwind.config = {

    theme: {

      extend: {

        colors: {

          brand: {

            50: "#f2f9ff",

            100: "#e6f3ff",

            200: "#cfe8ff",

            300: "#a7d4ff",

            400: "#73b8ff",

            500: "#3d9bff",

            600: "#1f7fe8",

            700: "#1a66b8",

            800: "#194f8a",

            900: "#173f6a",

          },

        },

      },

    },

  };

</script>



<script>

  document.addEventListener("DOMContentLoaded", () => {

    document.body.classList.add("min-h-screen", "bg-white", "text-slate-900");

  });

</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>



<link rel="stylesheet" href="styles/styles.css">
<meta property="og:title" content="Maps – Utah County Political Data">
<meta property="og:site_name" content="Utah County Political Data">
<meta name="twitter:title" content="Maps – Utah County Political Data">
<meta name="twitter:card" content="summary">
</head>

<body>

<header class="ucd-masthead">

  <div class="ucd-rule ucd-rule--top" aria-hidden="true"></div>



  <div class="ucd-masthead-inner">

    <a class="ucd-wordmark" href="./index.html">

      Utah County Political Data

    </a>



    <br>



    <nav class="ucd-nav" aria-label="Primary">

      <a class="ucd-navlink" href="./blog.html" data-nav="blog">Blog</a>

      <span class="ucd-dot" aria-hidden="true">·</span>

      <a class="ucd-navlink" href="./maps.html" data-nav="maps">Maps</a>

      <span class="ucd-dot" aria-hidden="true">·</span>

      <a class="ucd-navlink" href="./about.html" data-nav="about">About</a>

    </nav>

  </div>



  <div class="ucd-rule ucd-rule--bottom" aria-hidden="true"></div>

</header>


<header id="title-block-header">
<h1 class="title">Maps</h1>

</header>


<div class="column-screen">
<section class="bg-brand-50">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 py-8 sm:py-10">
    <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Maps</h1>
    <p class="mt-2 max-w-2xl text-sm sm:text-base leading-relaxed text-slate-700">
      Search precincts by <span class="font-semibold">PrecinctID</span> and highlight boundaries.
    </p>
  </div>
</section>

<section class="mx-auto max-w-6xl px-4 sm:px-6 pb-10">
  <!-- Mobile helper: collapsible controls -->
  <div class="pt-6">
    <button id="mobileControlsToggle" type="button" class="lg:hidden inline-flex w-full items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-900 shadow-sm" aria-controls="controlsPanel" aria-expanded="true">
      <span>Controls</span>
      <span id="mobileControlsChevron" class="text-slate-400" aria-hidden="true">▾</span>
    </button>
  </div>

  <div class="mt-4 grid gap-6 lg:grid-cols-12 lg:items-start">
    <!-- Controls -->
    <aside class="lg:col-span-4">
      <div id="controlsPanel" class="space-y-6 lg:sticky lg:top-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5 shadow-sm">
          <div class="text-sm font-semibold text-slate-900">Precinct search</div>
          <p class="mt-1 text-sm leading-relaxed text-slate-600">
            Search by PrecinctID (example: <span class="font-mono">25SR15</span>).
          </p>

          <div class="mt-3">
            <label class="sr-only" for="precinctSearch">PrecinctID</label>

            <div class="relative">
              <input id="precinctSearch" type="text" placeholder="Enter PrecinctID…" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-base sm:text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-4 focus:ring-[rgba(61,155,255,0.18)]" autocomplete="off" spellcheck="false" inputmode="search">

              <!-- typeahead dropdown -->
              <div id="precinctResults" class="absolute z-20 mt-2 hidden w-full overflow-hidden rounded-xl border border-slate-200 bg-white shadow-lg"></div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="btnGo" type="button" class="inline-flex w-full items-center justify-center rounded-xl bg-brand-600 px-4 py-3 text-sm font-semibold text-white hover:bg-brand-700 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-[rgba(61,155,255,0.25)]">
                Go
              </button>
              <button id="btnReset" type="button" class="inline-flex w-full items-center justify-center rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm font-semibold text-slate-800 hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-slate-200" title="Reset view">
                Reset
              </button>
            </div>

            <div id="statusMsg" class="mt-3 text-sm text-slate-600">
              Loading precinct boundaries…
            </div>
          </div>

          <hr class="my-5 border-slate-200">

          <div class="text-sm font-semibold text-slate-900">Layers</div>
          <div class="mt-3">
            <label class="flex cursor-pointer items-center gap-3 rounded-xl border border-slate-200 px-4 py-3 hover:bg-slate-50">
              <input id="togglePrecincts" type="checkbox" class="h-5 w-5" checked="">
              <span class="text-sm text-slate-800">Precinct boundaries</span>
            </label>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5 shadow-sm">
          <div class="text-sm font-semibold text-slate-900">Selection</div>
          <div id="selectionBox" class="mt-2 text-sm leading-relaxed text-slate-600">
            None selected.
          </div>
        </div>
      </div>
    </aside>

    <!-- Map + report -->
    <div class="lg:col-span-8 space-y-6">
      <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
        <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
          <div class="text-sm font-semibold text-slate-900">Utah County precincts</div>
          <div class="text-xs text-slate-500">Leaflet</div>
        </div>

        <!-- Responsive map height -->
        <div id="map" class="h-[52vh] min-h-[360px] sm:h-[520px] w-full"></div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5 shadow-sm">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <div class="text-sm font-semibold text-slate-900">Precinct report</div>
            <p class="mt-1 text-sm leading-relaxed text-slate-600">
              Vote totals by contest for the selected precinct (from your JSON files).
            </p>
          </div>

          <div class="flex w-full sm:w-auto items-center gap-2">
            <label for="electionSelect" class="text-xs font-semibold text-slate-600 whitespace-nowrap">Election</label>
            <select id="electionSelect" class="w-full sm:w-auto rounded-xl border border-slate-300 bg-white px-4 py-3 sm:px-3 sm:py-2 text-base sm:text-sm text-slate-900 focus:outline-none focus:ring-4 focus:ring-[rgba(61,155,255,0.18)]">
              <option value="">Loading…</option>
            </select>
          </div>
        </div>

        <div id="reportBox" class="mt-4 rounded-xl bg-slate-50 p-4 text-sm leading-relaxed text-slate-700">
          Select a precinct to populate this report.
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Mobile controls toggle script (small + safe) -->
<script>
  (function () {
    const btn = document.getElementById("mobileControlsToggle");
    const panel = document.getElementById("controlsPanel");
    const chev = document.getElementById("mobileControlsChevron");
    if (!btn || !panel) return;

    function setExpanded(expanded) {
      btn.setAttribute("aria-expanded", expanded ? "true" : "false");
      if (expanded) {
        panel.classList.remove("hidden");
        if (chev) chev.textContent = "▾";
      } else {
        panel.classList.add("hidden");
        if (chev) chev.textContent = "▸";
      }
    }

    // default: open on mobile
    setExpanded(true);

    btn.addEventListener("click", () => {
      const expanded = btn.getAttribute("aria-expanded") === "true";
      setExpanded(!expanded);
    });
  })();
</script>
</div>


<script>

  (function () {

    // Mark active nav item based on current page path (and hash for in-page anchors)

    const path = (window.location.pathname || "").toLowerCase();

    const hash = (window.location.hash || "").toLowerCase();

    const links = document.querySelectorAll(".ucd-navlink[data-nav]");



    // Decide which nav key should be active

    let activeKey = "";



    const isBlog = path.endsWith("/blog.html") || path.endsWith("blog.html");

    const isMaps = path.endsWith("/maps.html") || path.endsWith("maps.html");

    const isAbout = path.endsWith("/about.html") || path.endsWith("about.html");

    const isHome = path.endsWith("/index.html") || path.endsWith("index.html") || path.endsWith("/");



    if (isBlog) {

      activeKey = "blog";

    } else if (isMaps) {

      activeKey = "maps";

    } else if (isAbout) {

      activeKey = "about";

    } else if (isHome) {

      // Home page uses anchors for sections

      if (hash === "#maps") activeKey = "maps";

      else if (hash === "#about") activeKey = "about";

      else activeKey = ""; // no underline on home by default

    }



    links.forEach((a) => {

      const key = (a.getAttribute("data-nav") || "").toLowerCase();

      if (key && key === activeKey) {

        a.setAttribute("aria-current", "page");

      } else {

        a.removeAttribute("aria-current");

      }

    });

  })();

</script>

<script>

  (function () {

    const yearEl = document.getElementById("year");

    if (yearEl) yearEl.textContent = new Date().getFullYear();

  })();

</script>

<style>

  #title-block-header {

    display: none !important;

  }



  /* If Quarto toggles the "no matching items" element on/off,

     just hide it permanently. */

  .listing-no-matching,

  .listing-no-matching.d-none {

    display: none !important;

  }

</style>



<script>

  document.addEventListener("DOMContentLoaded", function () {

    // Your hero title/subtitle injector

    const settings = document.getElementById("hero-settings");



    if (settings) {

      const titleText = settings.getAttribute("data-title");

      const subtitleText = settings.getAttribute("data-subtitle");



      const titleEl = document.getElementById("hero-title");

      const subtitleEl = document.getElementById("hero-subtitle");



      if (titleEl && titleText) titleEl.innerText = titleText;

      if (subtitleEl && subtitleText) subtitleEl.innerText = subtitleText;



      settings.remove();

    }



    // Remove "No matching items" block if it exists

    const noMatching = document.querySelector(".listing-no-matching");

    if (noMatching) noMatching.remove();

  });

</script>

<script>

  (function () {

    // =========================================================

    // Config (maintainability)

    // =========================================================

    const CFG = {

      csvUrl: "data/to/utah_county_elections.csv",



      // Join key from the map

      precinctField: "precinct_code",



      // Election identity

      electionDateField: "election_date",

      electionNameField: "election_name",



      // Grouping

      contestField: "contest_name",

      contestTypeField: "contest_type",

      choiceField: "choice_name",



      // Metrics

      votesField: "precinct_votes",

      ballotsCastField: "precinct_ballots_cast",

      turnoutField: "voter_turnout",

      registrationField: "voter_registration",

      turnoutRateField: "turnout_rate_precinct",



      // Contest summary (repeated per choice row)

      contestTotalVotesField: "contest_total_votes",

      contestParticipationRateField: "contest_participation_rate",

      rolloffRateField: "rolloff_rate",

      polarizationField: "polarization_fragmentation",



      // Outcome summary (repeated per choice row)

      winnerChoiceField: "winner_choice_name",

      runnerupChoiceField: "runnerup_choice_name",

      winnerVotesField: "winner_votes",

      runnerupVotesField: "runnerup_votes",

      marginVotesField: "margin_votes",

      marginPctField: "margin_pct",



      // Choice detail

      choiceShareField: "choice_share",

      choiceRankField: "choice_rank",

    };



    // =========================================================

    // DOM

    // =========================================================

    const ui = {

      electionSelect: document.getElementById("electionSelect"),

      reportBox: document.getElementById("reportBox"),

    };



    // =========================================================

    // State / Indexes

    // =========================================================

    const state = {

      loaded: false,

      elections: [], // [{ key, date, name, label }]

      activeElectionKey: "",



      // electionKey -> precinctCode -> contestName -> rows[]

      idx: new Map(),



      // electionKey|precinctCode -> { ballotsCast, turnout, registration, turnoutRate }

      precinctMeta: new Map(),

    };



    // =========================================================

    // Small utilities

    // =========================================================

    const esc = (s) =>

      String(s ?? "")

        .replaceAll("&", "&amp;")

        .replaceAll("<", "&lt;")

        .replaceAll(">", "&gt;")

        .replaceAll('"', "&quot;")

        .replaceAll("'", "&#039;");



    const norm = (v) => (v ?? "").toString().trim();



    const toNum = (v) => {

      if (v === null || v === undefined) return null;

      const s = String(v).trim();

      if (!s) return null;

      const n = Number(s);

      return Number.isFinite(n) ? n : null;

    };



    const fmtInt = (n) => (Number.isFinite(n) ? Math.round(n).toLocaleString() : "—");

    const fmtPct = (x, digits = 1) =>

      Number.isFinite(x) ? `${(x * 100).toFixed(digits)}%` : "—";

    const fmtPctAbs = (x, digits = 1) =>

      Number.isFinite(x) ? `${x.toFixed(digits)}%` : "—";

    const fmtFloat = (x, digits = 3) =>

      Number.isFinite(x) ? x.toFixed(digits) : "—";



    function setReport(html) {

      if (!ui.reportBox) return;

      ui.reportBox.innerHTML = html;

    }



    function setElectionSelectOptions() {

      if (!ui.electionSelect) return;



      if (!state.elections.length) {

        ui.electionSelect.innerHTML = `<option value="">No elections found</option>`;

        return;

      }



      // Default election: latest date (already sorted desc)

      if (!state.activeElectionKey) state.activeElectionKey = state.elections[0].key;



      ui.electionSelect.innerHTML = state.elections

        .map((e) => {

          const sel = e.key === state.activeElectionKey ? "selected" : "";

          return `<option value="${esc(e.key)}" ${sel}>${esc(e.label)}</option>`;

        })

        .join("");

    }



    // =========================================================

    // CSV parsing (simple + quote-aware per line)

    // =========================================================

    function splitCSVLine(line) {

      const out = [];

      let cur = "";

      let inQ = false;



      for (let i = 0; i < line.length; i++) {

        const c = line[i];



        if (c === '"') {

          // escaped quote

          if (inQ && line[i + 1] === '"') {

            cur += '"';

            i++;

          } else {

            inQ = !inQ;

          }

        } else if (c === "," && !inQ) {

          out.push(cur);

          cur = "";

        } else {

          cur += c;

        }

      }

      out.push(cur);

      return out;

    }



    function parseCSV(text) {

      const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");

      const nonEmpty = lines.filter((l) => l.trim().length > 0);

      if (!nonEmpty.length) return [];



      const header = splitCSVLine(nonEmpty[0]).map((h) => h.trim());

      const rows = [];



      for (let i = 1; i < nonEmpty.length; i++) {

        const cols = splitCSVLine(nonEmpty[i]);

        if (!cols.length) continue;



        const obj = {};

        for (let j = 0; j < header.length; j++) {

          obj[header[j]] = cols[j] ?? "";

        }

        rows.push(obj);

      }



      return rows;

    }



    // =========================================================

    // Index building

    // =========================================================

    function electionKey(row) {

      const d = norm(row[CFG.electionDateField]);

      const n = norm(row[CFG.electionNameField]);

      return `${d}|${n}`;

    }



    function buildIndexes(rows) {

      const electionSeen = new Map(); // key -> {date,name}



      for (const r0 of rows) {

        const r = r0;



        // normalize strings

        const precinct = norm(r[CFG.precinctField]).toUpperCase();

        const eDate = norm(r[CFG.electionDateField]);

        const eName = norm(r[CFG.electionNameField]);

        const contest = norm(r[CFG.contestField]);

        const contestType = norm(r[CFG.contestTypeField]);

        const choice = norm(r[CFG.choiceField]);



        if (!precinct || !eName || !eDate || !contest || !choice) continue;



        // cast numeric-ish fields

        const votes = toNum(r[CFG.votesField]);

        const ballotsCast = toNum(r[CFG.ballotsCastField]);

        const turnout = toNum(r[CFG.turnoutField]);

        const registration = toNum(r[CFG.registrationField]);

        const turnoutRate = toNum(r[CFG.turnoutRateField]);



        const contestTotalVotes = toNum(r[CFG.contestTotalVotesField]);

        const contestParticipationRate = toNum(r[CFG.contestParticipationRateField]);

        const rolloffRate = toNum(r[CFG.rolloffRateField]);

        const polarization = toNum(r[CFG.polarizationField]);



        const winnerVotes = toNum(r[CFG.winnerVotesField]);

        const runnerupVotes = toNum(r[CFG.runnerupVotesField]);

        const marginVotes = toNum(r[CFG.marginVotesField]);

        const marginPct = toNum(r[CFG.marginPctField]);



        const choiceShare = toNum(r[CFG.choiceShareField]);

        const choiceRank = toNum(r[CFG.choiceRankField]);



        const winnerChoiceName = norm(r[CFG.winnerChoiceField]);

        const runnerupChoiceName = norm(r[CFG.runnerupChoiceField]);



        const ek = `${eDate}|${eName}`;

        electionSeen.set(ek, { date: eDate, name: eName });



        // idx init

        if (!state.idx.has(ek)) state.idx.set(ek, new Map());

        const eMap = state.idx.get(ek);



        if (!eMap.has(precinct)) eMap.set(precinct, new Map());

        const pMap = eMap.get(precinct);



        if (!pMap.has(contest)) pMap.set(contest, []);

        const bucket = pMap.get(contest);



        bucket.push({

          precinct,

          eDate,

          eName,

          contest,

          contestType,

          choice,



          votes,

          ballotsCast,

          turnout,

          registration,

          turnoutRate,



          contestTotalVotes,

          contestParticipationRate,

          rolloffRate,

          polarization,



          winnerChoiceName,

          runnerupChoiceName,

          winnerVotes,

          runnerupVotes,

          marginVotes,

          marginPct,



          choiceShare,

          choiceRank,

        });



        // precinct meta (store once)

        const metaKey = `${ek}|${precinct}`;

        if (!state.precinctMeta.has(metaKey)) {

          state.precinctMeta.set(metaKey, {

            ballotsCast,

            turnout,

            registration,

            turnoutRate,

          });

        } else {

          // fill blanks if needed

          const m = state.precinctMeta.get(metaKey);

          if (!Number.isFinite(m.ballotsCast) && Number.isFinite(ballotsCast)) m.ballotsCast = ballotsCast;

          if (!Number.isFinite(m.turnout) && Number.isFinite(turnout)) m.turnout = turnout;

          if (!Number.isFinite(m.registration) && Number.isFinite(registration)) m.registration = registration;

          if (!Number.isFinite(m.turnoutRate) && Number.isFinite(turnoutRate)) m.turnoutRate = turnoutRate;

        }

      }



      // elections list (sort desc by date)

      state.elections = Array.from(electionSeen.entries())

        .map(([key, v]) => ({

          key,

          date: v.date,

          name: v.name,

          label: `${v.date} · ${v.name}`,

        }))

        .sort((a, b) => (a.date < b.date ? 1 : a.date > b.date ? -1 : a.name.localeCompare(b.name)));

    }



    // =========================================================

    // Rendering

    // =========================================================

    function contestSortKey(rows) {

      // prefer higher contest_total_votes, fallback to winner_votes

      const r = rows[0] || {};

      const a = Number.isFinite(r.contestTotalVotes) ? r.contestTotalVotes : -1;

      const b = Number.isFinite(r.winnerVotes) ? r.winnerVotes : -1;

      return a !== -1 ? a : b;

    }



    function renderContestBlock(contestName, rows) {

      // sort choices by rank then votes desc

      const sorted = [...rows].sort((a, b) => {

        const ar = Number.isFinite(a.choiceRank) ? a.choiceRank : 9999;

        const br = Number.isFinite(b.choiceRank) ? b.choiceRank : 9999;

        if (ar !== br) return ar - br;

        const av = Number.isFinite(a.votes) ? a.votes : -1;

        const bv = Number.isFinite(b.votes) ? b.votes : -1;

        return bv - av;

      });



      const r0 = sorted[0] || {};

      const winner = r0.winnerChoiceName || "—";

      const runner = r0.runnerupChoiceName || "—";



      const headerRight = `

        <div class="text-xs text-slate-500">

          <span class="font-semibold text-slate-700">${fmtInt(r0.contestTotalVotes)}</span> votes

          <span class="mx-2 text-slate-300">•</span>

          margin <span class="font-semibold text-slate-700">${fmtInt(r0.marginVotes)}</span>

          (${fmtPct(r0.marginPct, 1)})

        </div>

      `;



      const metaRow = `

        <div class="mt-3 grid gap-2 sm:grid-cols-3 text-xs text-slate-600">

          <div class="rounded-lg bg-slate-50 px-3 py-2">

            <div class="uppercase tracking-wide text-[10px] text-slate-500">Winner</div>

            <div class="font-semibold text-slate-900">${esc(winner)}</div>

          </div>

          <div class="rounded-lg bg-slate-50 px-3 py-2">

            <div class="uppercase tracking-wide text-[10px] text-slate-500">Runner-up</div>

            <div class="font-semibold text-slate-900">${esc(runner)}</div>

          </div>

          <div class="rounded-lg bg-slate-50 px-3 py-2">

            <div class="uppercase tracking-wide text-[10px] text-slate-500">Participation</div>

            <div class="font-semibold text-slate-900">

              ${fmtFloat(r0.contestParticipationRate, 3)}

              <span class="text-slate-500 font-normal">(votes/ballot)</span>

            </div>

          </div>

        </div>

      `;



      const tableRows = sorted

        .map((x) => {

          const share = fmtPct(x.choiceShare, 1);

          return `

            <tr class="border-t border-slate-200">

              <td class="px-3 py-2 text-slate-900">${esc(x.choice)}</td>

              <td class="px-3 py-2 text-right font-mono text-slate-900">${fmtInt(x.votes)}</td>

              <td class="px-3 py-2 text-right text-slate-700">${share}</td>

              <td class="px-3 py-2 text-right text-slate-500">${Number.isFinite(x.choiceRank) ? x.choiceRank : "—"}</td>

            </tr>

          `;

        })

        .join("");



      return `

        <details class="group rounded-xl border border-slate-200 bg-white">

          <summary class="cursor-pointer list-none px-4 py-3">

            <div class="flex items-start justify-between gap-4">

              <div>

                <div class="text-sm font-semibold text-slate-900">${esc(contestName)}</div>

                <div class="mt-0.5 text-xs text-slate-500">${esc(r0.contestType || "")}</div>

              </div>

              <div class="hidden sm:block">${headerRight}</div>

            </div>

            <div class="mt-2 sm:hidden">${headerRight}</div>

            <div class="mt-2 text-xs text-slate-500 group-open:hidden">Click to expand</div>

          </summary>



            <div class="mt-4 overflow-hidden rounded-lg border border-slate-200">

              <table class="w-full text-sm">

                <thead class="bg-slate-50 text-xs text-slate-600">

                  <tr>

                    <th class="px-3 py-2 text-left font-semibold">Choice</th>

                    <th class="px-3 py-2 text-right font-semibold">Votes</th>

                    <th class="px-3 py-2 text-right font-semibold">Share</th>

                    <th class="px-3 py-2 text-right font-semibold">Rank</th>

                  </tr>

                </thead>

                <tbody class="bg-white">

                  ${tableRows}

                </tbody>

              </table>

            </div>



            <div class="mt-3 text-xs text-slate-500">

              Fragmentation: <span class="font-mono text-slate-700">${fmtFloat(r0.polarization, 3)}</span>

              <span class="mx-2 text-slate-300">•</span>

              Roll-off rate: <span class="font-mono text-slate-700">${fmtFloat(r0.rolloffRate, 3)}</span>

            </div>

          </div>

        </details>

      `;

    }



    function renderForPrecinct(precinctCodeRaw) {

      const precinctCode = norm(precinctCodeRaw).toUpperCase();



      if (!state.loaded) {

        setReport(`<div class="text-sm text-slate-700">Loading election data…</div>`);

        return;

      }



      const ek = state.activeElectionKey || (state.elections[0] && state.elections[0].key) || "";

      if (!ek) {

        setReport(`<div class="text-sm text-slate-700">No election data available.</div>`);

        return;

      }



      const eMap = state.idx.get(ek);

      const pMap = eMap ? eMap.get(precinctCode) : null;



      if (!precinctCode) {

        setReport(`<div class="text-sm text-slate-700">Select a precinct to populate this report.</div>`);

        return;

      }



      if (!pMap) {

        setReport(`

          <div class="text-sm text-slate-700">

            <div class="font-semibold text-slate-900">No data for ${esc(precinctCode)}</div>

            <div class="mt-1 text-slate-600">This precinct may not participate in the selected election, or results are missing.</div>

          </div>

        `);

        return;

      }



      const meta = state.precinctMeta.get(`${ek}|${precinctCode}`) || {};

      const ballotsCast = meta.ballotsCast;

      const turnout = meta.turnout;

      const reg = meta.registration;



      // Prefer computed turnoutRate, otherwise derive

      const turnoutRate =

        Number.isFinite(meta.turnoutRate)

          ? meta.turnoutRate

          : (Number.isFinite(turnout) && Number.isFinite(reg) && reg > 0 ? turnout / reg : null);



      // contests sorted by vote volume

      const contests = Array.from(pMap.entries())

        .sort((a, b) => contestSortKey(b[1]) - contestSortKey(a[1]));



      const electionLabel = state.elections.find((x) => x.key === ek)?.label || ek;



      const contestBlocks = contests

        .map(([contestName, rows]) => renderContestBlock(contestName, rows))

        .join('<div class="h-3"></div>');



      setReport(`

        <div class="space-y-4">

          <div class="flex flex-col gap-1">

            <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Selected precinct</div>

            <div class="flex flex-wrap items-end justify-between gap-3">

              <div class="text-lg font-semibold text-slate-900">

                <span class="font-mono">${esc(precinctCode)}</span>

              </div>

              <div class="text-xs text-slate-500">${esc(electionLabel)}</div>

            </div>

          </div>



          <div class="grid gap-3 sm:grid-cols-3">

            <div class="rounded-xl border border-slate-200 bg-white p-4">

              <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Registered</div>

              <div class="mt-1 text-xl font-semibold text-slate-900">${fmtInt(reg)}</div>

            </div>

            <div class="rounded-xl border border-slate-200 bg-white p-4">

              <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Ballots cast</div>

              <div class="mt-1 text-xl font-semibold text-slate-900">${fmtInt(ballotsCast)}</div>

            </div>

            <div class="rounded-xl border border-slate-200 bg-white p-4">

              <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Turnout rate</div>

              <div class="mt-1 text-xl font-semibold text-slate-900">${fmtPct(turnoutRate, 1)}</div>

              <div class="mt-1 text-xs text-slate-500">Turnout: ${fmtInt(turnout)}</div>

            </div>

          </div>



          <div class="pt-1">

            <div class="text-sm font-semibold text-slate-900">Contests</div>

            <div class="mt-2 space-y-3">

              ${contestBlocks}

            </div>

          </div>

        </div>

      `);

    }



    // =========================================================

    // Load + init

    // =========================================================

    async function load() {

      setReport(`<div class="text-sm text-slate-700">Loading election data…</div>`);



      let text = "";

      try {

        const res = await fetch(CFG.csvUrl, { cache: "no-store" });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        text = await res.text();

      } catch (err) {

        console.error(err);

        setReport(`

          <div class="text-sm text-red-700">

            Failed to load <span class="font-mono">${esc(CFG.csvUrl)}</span>. Check the path and Quarto resources.

          </div>

        `);

        return;

      }



      const rows = parseCSV(text);

      buildIndexes(rows);



      state.loaded = true;

      state.activeElectionKey = state.elections[0] ? state.elections[0].key : "";



      setElectionSelectOptions();



      // Render if a precinct was already selected by the map script

      const last = (window.UCD_LAST_SELECTED_PRECINCT || "").toString().trim();

      if (last) renderForPrecinct(last);

      else setReport(`<div class="text-sm text-slate-700">Select a precinct to populate this report.</div>`);

    }



    // Election change handler

    if (ui.electionSelect) {

      ui.electionSelect.addEventListener("change", () => {

        state.activeElectionKey = ui.electionSelect.value || "";

        const last = (window.UCD_LAST_SELECTED_PRECINCT || "").toString().trim();

        if (last) renderForPrecinct(last);

        else setReport(`<div class="text-sm text-slate-700">Select a precinct to populate this report.</div>`);

      });

    }



    // Expose hook for the map script

    window.UCDReports = {

      renderForPrecinct,

    };



    load();

  })();

</script>

<script>

  (function () {

    // =========================================================

    // Config (keep maintainable)

    // =========================================================

    const CFG = {

      datasetUrl: "data/geo/utah_county_precincts.min.geojson",

      searchField: "PrecinctID",

      displayFields: ["PrecinctID", "SubPrecinctID", "CountyID"],

      defaultView: { center: [40.2338, -111.6585], zoom: 10 },

      fitPadding: [24, 24],

      typeahead: { limit: 10, minChars: 1 },

    };



    // =========================================================

    // DOM

    // =========================================================

    const ui = {

      search: document.getElementById("precinctSearch"),

      results: document.getElementById("precinctResults"),

      status: document.getElementById("statusMsg"),

      selection: document.getElementById("selectionBox"),

      btnGo: document.getElementById("btnGo"),

      btnReset: document.getElementById("btnReset"),

      togglePrecincts: document.getElementById("togglePrecincts"),

    };



    // =========================================================

    // Map

    // =========================================================

    const map = L.map("map", { zoomControl: true, scrollWheelZoom: false })

      .setView(CFG.defaultView.center, CFG.defaultView.zoom);



    // Only enable scroll-wheel zoom when the map is "active"

    map.on("focus", () => map.scrollWheelZoom.enable());

    map.on("blur", () => map.scrollWheelZoom.disable());



    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {

      maxZoom: 19,

      attribution: "&copy; OpenStreetMap",

    }).addTo(map);



    // =========================================================

    // State / indexes

    // =========================================================

    let precinctLayer = null;



    // normalized PrecinctID -> { id, layers: [layer...], propsSample }

    const index = new Map();

    let keys = [];



    let selectedKey = null;

    let selectedLayers = [];



    // =========================================================

    // Styling

    // =========================================================

    const style = {

      base: () => ({

        color: "#64748b",

        weight: 1,

        opacity: 0.85,

        fillColor: "#3d9bff",

        fillOpacity: 0.06,

      }),

      highlight: () => ({

        color: "#1a66b8",

        weight: 3,

        opacity: 1,

        fillColor: "#3d9bff",

        fillOpacity: 0.18,

      }),

    };



    // =========================================================

    // Helpers

    // =========================================================

    const norm = (v) => (v ?? "").toString().trim().toUpperCase();



    function setStatus(msg, tone = "normal") {

      if (!ui.status) return;

      ui.status.textContent = msg;

      ui.status.className = "mt-3 text-sm " + (tone === "error" ? "text-red-700" : "text-slate-600");

    }



    function setSelection(html) {

      if (ui.selection) ui.selection.innerHTML = html;

    }



    function safe(v) {

      return v === null || v === undefined || v === "" ? "—" : String(v);

    }



    function infoHTML(props) {

      const p = props || {};

      return `

        <div class="space-y-1">

          <div>

            <span class="text-xs uppercase tracking-wider text-slate-500">PrecinctID</span>

            <div class="font-mono text-slate-900">${safe(p.PrecinctID)}</div>

          </div>

          <div>

            <span class="text-xs uppercase tracking-wider text-slate-500">CountyID</span>

            <div class="font-mono text-slate-900">${safe(p.CountyID)}</div>

          </div>

        </div>

      `;

      }



    function hideResults() {

      if (!ui.results) return;

      ui.results.classList.add("hidden");

      ui.results.innerHTML = "";

    }



    function showResults(ids) {

      if (!ui.results) return;

      if (!ids.length) return hideResults();



      ui.results.innerHTML = ids

        .map(

          (id) => `

            <button

              type="button"

              class="w-full px-4 py-3 text-left text-base sm:text-sm hover:bg-slate-50 active:bg-slate-100"

              data-pick="${id}"

            >

              <span class="font-mono">${id}</span>

            </button>

          `

        )

        .join("");



      // Mobile: keep dropdown usable and on-screen

      ui.results.style.maxHeight = "240px";

      ui.results.style.overflowY = "auto";

      ui.results.style.webkitOverflowScrolling = "touch";



      ui.results.classList.remove("hidden");



      ui.results.querySelectorAll("[data-pick]").forEach((btn) => {

        btn.addEventListener("click", () => {

          const id = btn.getAttribute("data-pick") || "";

          ui.search.value = id;

          hideResults();

          selectByInput(id);

        });

      });

    }





    function clearHighlight() {

      selectedKey = null;



      if (precinctLayer) {

        selectedLayers.forEach((lyr) => {

          try {

            precinctLayer.resetStyle(lyr);

          } catch {}

        });

      }



      selectedLayers = [];

      map.closePopup();

      setSelection("None selected.");

    }



    function resetAll() {

      clearHighlight();

      hideResults();

      if (ui.search) ui.search.value = "";

      map.setView(CFG.defaultView.center, CFG.defaultView.zoom);

      setStatus("Ready.");

    }



    function layersBounds(layers) {

      return L.featureGroup(layers).getBounds();

    }



    function applyHighlight(key) {

      clearHighlight();



      const entry = index.get(key);

      if (!entry) return;



      selectedKey = key;

      selectedLayers = entry.layers;



      selectedLayers.forEach((lyr) => {

        lyr.setStyle(style.highlight());

        try {

          lyr.bringToFront();

        } catch {}

      });



      const b = layersBounds(selectedLayers);

      map.fitBounds(b, { padding: CFG.fitPadding });



      const popupHtml = `

        <div style="min-width: 220px">

          <div style="font-weight:700; margin-bottom:6px;">Precinct</div>

          ${infoHTML(entry.propsSample)}

        </div>

      `;



      L.popup({ closeButton: true, autoPan: true })

        .setLatLng(b.getCenter())

        .setContent(popupHtml)

        .openOn(map);



      setSelection(infoHTML(entry.propsSample));



      const count = entry.layers.length;

      setStatus(count > 1 ? `Selected ${entry.id} (${count} features)` : `Selected ${entry.id}`);



      // Hook: update precinct report panel if present

      window.UCD_LAST_SELECTED_PRECINCT = entry.id;

      if (window.UCDReports && typeof window.UCDReports.renderForPrecinct === "function") {

        window.UCDReports.renderForPrecinct(entry.id);

      }

    }



    function selectByInput(raw) {

      const key = norm(raw);

      if (!key) return setStatus("Enter a PrecinctID.", "error");



      if (!index.has(key)) {

        clearHighlight();

        setStatus(`No precinct found for "${raw}".`, "error");

        setSelection(

          `<span class="text-red-700">No precinct found for <span class="font-mono">${safe(raw)}</span>.</span>`

        );



        // Clear report if present

        window.UCD_LAST_SELECTED_PRECINCT = "";

        const report = document.getElementById("reportBox");

        if (report) report.innerHTML = "Select a precinct to populate this report.";



        return;

      }



      applyHighlight(key);

    }



    // =========================================================

    // GeoJSON loading + indexing

    // =========================================================

    async function loadPrecincts() {

      setStatus("Loading precinct boundaries…");



      let geojson;

      try {

        const res = await fetch(CFG.datasetUrl, { cache: "no-store" });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        geojson = await res.json();

      } catch (err) {

        console.error(err);

        setStatus("Failed to load precinct GeoJSON. Check the file path and site build output.", "error");

        return;

      }



      precinctLayer = L.geoJSON(geojson, {

        style: style.base,

        onEachFeature: (feature, layer) => {

          const props = feature && feature.properties ? feature.properties : {};

          const rawId = props[CFG.searchField];

          const key = norm(rawId);

          if (!key) return;



          const existing = index.get(key);

          if (!existing) {

            index.set(key, {

              id: String(rawId).trim(),

              layers: [layer],

              propsSample: {

                PrecinctID: props.PrecinctID,

                CountyID: props.CountyID,

              },

            });

          } else {

            existing.layers.push(layer);

          }



          layer.on("click", () => {

            if (ui.search) ui.search.value = index.get(key)?.id ?? String(rawId);

            hideResults();

            applyHighlight(key);

          });

        },

      });



      precinctLayer.addTo(map);

      keys = Array.from(index.keys()).sort();

      setStatus(`Ready. Loaded ${keys.length.toLocaleString()} precinct IDs.`);

    }



    // =========================================================

    // Typeahead

    // =========================================================

    function suggestions(query) {

      const q = norm(query);

      if (!q || q.length < CFG.typeahead.minChars) return [];



      const out = [];

      for (let i = 0; i < keys.length; i++) {

        const k = keys[i];

        if (k.includes(q)) {

          out.push(index.get(k).id);

          if (out.length >= CFG.typeahead.limit) break;

        }

      }

      return out;

    }



    if (ui.search) {

      ui.search.addEventListener("input", () => {

        const s = suggestions(ui.search.value || "");

        if (!s.length) return hideResults();

        showResults(s);

      });



      ui.search.addEventListener("keydown", (e) => {

        if (e.key === "Enter") {

          e.preventDefault();

          hideResults();

          selectByInput(ui.search.value);

        }

        if (e.key === "Escape") hideResults();

      });

    }



    if (ui.btnGo) {

      ui.btnGo.addEventListener("click", () => {

        hideResults();

        selectByInput(ui.search.value);

      });

    }



    if (ui.btnReset) {

      ui.btnReset.addEventListener("click", resetAll);

    }



    document.addEventListener("click", (e) => {

      const within = (ui.results && ui.results.contains(e.target)) || (ui.search && ui.search.contains(e.target));

      if (!within) hideResults();

    });



    if (ui.togglePrecincts) {

      ui.togglePrecincts.addEventListener("change", () => {

        if (!precinctLayer) return;

        if (ui.togglePrecincts.checked) precinctLayer.addTo(map);

        else map.removeLayer(precinctLayer);

      });

    }



    // =========================================================

    // Start

    // =========================================================

    resetAll();

    loadPrecincts();

  })();

</script>





</body></html>