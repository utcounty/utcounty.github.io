<script>
  (function () {
    // =========================
    // Config (add more later)
    // =========================
    const ELECTION_SOURCES = [
      {
        id: "2025-11-04",
        url: "data/to/20251104_utah_county_municipal_general_election.json",
      },
      {
        id: "2025-08-12",
        url: "data/to/20250812_utah_county_municipal_primary_election.json",
      },
    ];

    // Set to "Utah County" if your files include multiple counties.
    // If your JSON already contains only Utah County, you can set this to null.
    const COUNTY_NAME_FILTER = "Utah County";

    // Precinct key in the election JSON precinctResults objects (they use .name like "25SR15")
    const PRECINCT_KEY_FIELD = "name";

    // =========================
    // DOM
    // =========================
    const elSelect = document.getElementById("electionSelect");
    const elReport = document.getElementById("reportBox");

    // =========================
    // Index structures
    // =========================
    // REPORT_INDEX:
    // Map precinctKey -> Map electionId -> { meta, contests: [...] }
    const REPORT_INDEX = new Map();

    // Elections metadata (id -> meta)
    const ELECTION_META = new Map();

    // =========================
    // Helpers
    // =========================
    function normalize(s) {
      return (s ?? "").toString().trim().toUpperCase();
    }

    function safe(v) {
      return v === null || v === undefined || v === "" ? "—" : String(v);
    }

    function parseDate(iso) {
      // iso like "2025-11-04"
      try {
        const d = new Date(iso + "T00:00:00");
        return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      } catch {
        return iso;
      }
    }

    function statusRank(s) {
      // worse = higher number
      const t = (s || "").toLowerCase();
      if (t.includes("not")) return 3;
      if (t.includes("partial")) return 2;
      if (t.includes("report")) return 1; // "Reported"
      return 0;
    }

    function worstStatus(statuses) {
      if (!statuses.length) return "—";
      let worst = statuses[0];
      for (const s of statuses) {
        if (statusRank(s) > statusRank(worst)) worst = s;
      }
      return worst || "—";
    }

    function ensurePrecinctElection(precinctKey, electionId, meta) {
      if (!REPORT_INDEX.has(precinctKey)) REPORT_INDEX.set(precinctKey, new Map());
      const perElection = REPORT_INDEX.get(precinctKey);
      if (!perElection.has(electionId)) perElection.set(electionId, { meta, contests: [] });
      return perElection.get(electionId);
    }

    // =========================
    // Parse election JSON -> index
    // =========================
    function indexElectionJson(data, source) {
      const meta = {
        id: source.id,
        url: source.url,
        electionDate: safe(data.electionDate),
        electionName: safe(data.electionName),
        createdAt: safe(data.createdAt),
      };
      ELECTION_META.set(meta.id, meta);

      const localResults = Array.isArray(data.localResults) ? data.localResults : [];

      const counties = COUNTY_NAME_FILTER
        ? localResults.filter((c) => normalize(c.name) === normalize(COUNTY_NAME_FILTER))
        : localResults;

      // If county filter yields nothing, fall back to all localResults
      const workingCounties = counties.length ? counties : localResults;

      for (const county of workingCounties) {
        const ballotItems = Array.isArray(county.ballotItems) ? county.ballotItems : [];

        for (const item of ballotItems) {
          const contestName = safe(item.name);
          const contestId = safe(item.id);
          const voteFor = Number(item.voteFor || 1);

          const options = Array.isArray(item.ballotOptions) ? item.ballotOptions : [];
          if (!options.length) continue;

          // Build per-precinct accumulator for this contest
          // Map precinctKey -> { options: [{name, votes, status}], statuses: [] }
          const perPrecinct = new Map();

          for (const opt of options) {
            const pr = Array.isArray(opt.precinctResults) ? opt.precinctResults : [];
            if (!pr.length) continue;

            for (const row of pr) {
              const precinctRaw = row && row[PRECINCT_KEY_FIELD];
              const precinctKey = normalize(precinctRaw);
              if (!precinctKey) continue;

              if (!perPrecinct.has(precinctKey)) {
                perPrecinct.set(precinctKey, { options: [], statuses: [] });
              }
              const acc = perPrecinct.get(precinctKey);

              const rc = Number(row.voteCount || 0);
              const rs = safe(row.reportingStatus);

              acc.options.push({
                candidateId: safe(opt.id),
                candidateName: safe(opt.name),
                votes: rc,
                reportingStatus: rs,
              });
              acc.statuses.push(rs);
            }
          }

          // Commit contest for each precinct where we found results
          for (const [precinctKey, acc] of perPrecinct.entries()) {
            const totalVotes = acc.options.reduce((s, o) => s + (Number(o.votes) || 0), 0);
            const contestStatus = worstStatus(acc.statuses);

            const bucket = ensurePrecinctElection(precinctKey, meta.id, meta);
            bucket.contests.push({
              contestId,
              contestName,
              voteFor,
              totalVotes,
              reportingStatus: contestStatus,
              options: acc.options.sort((a, b) => (b.votes || 0) - (a.votes || 0)),
            });
          }
        }
      }
    }

    // =========================
    // Render
    // =========================
    function renderForPrecinct(precinctIdRaw) {
      const precinctKey = normalize(precinctIdRaw);
      if (!precinctKey) return;

      if (!REPORT_INDEX.has(precinctKey)) {
        elReport.innerHTML =
          `<div class="text-slate-700">No election results found for <span class="font-mono">${safe(precinctIdRaw)}</span> ` +
          `in the loaded JSON files.</div>`;
        return;
      }

      const perElection = REPORT_INDEX.get(precinctKey);

      // pick election from dropdown (or first available)
      let electionId = elSelect && elSelect.value ? elSelect.value : "";
      if (!electionId || !perElection.has(electionId)) {
        electionId = Array.from(perElection.keys()).sort().reverse()[0];
        if (elSelect) elSelect.value = electionId;
      }

      const pack = perElection.get(electionId);
      const meta = pack.meta;

      // sort contests by name (or keep input order)
      const contests = pack.contests.slice();

      // Ballots-cast proxy: max totalVotes among voteFor == 1 contests
      const singleSeat = contests.filter((c) => c.voteFor === 1);
      const ballotsProxy = singleSeat.length
        ? Math.max(...singleSeat.map((c) => c.totalVotes || 0))
        : null;

      const header = `
        <div class="mb-3">
          <div class="text-sm font-semibold text-slate-900">${safe(meta.electionName)}</div>
          <div class="text-xs text-slate-600">${parseDate(meta.electionDate)} · Precinct <span class="font-mono">${safe(precinctIdRaw)}</span></div>
        </div>
      `;

      const summary = `
        <div class="grid gap-2 sm:grid-cols-3 mb-4">
          <div class="rounded-md bg-white p-3 border border-slate-200">
            <div class="text-xs uppercase tracking-wider text-slate-500">Contests</div>
            <div class="text-lg font-semibold text-slate-900">${contests.length.toLocaleString()}</div>
          </div>
          <div class="rounded-md bg-white p-3 border border-slate-200">
            <div class="text-xs uppercase tracking-wider text-slate-500">Ballots proxy</div>
            <div class="text-lg font-semibold text-slate-900">${ballotsProxy === null ? "—" : ballotsProxy.toLocaleString()}</div>
            <div class="text-[11px] text-slate-500 mt-1">Max votes in vote-for-1 contest (not official turnout)</div>
          </div>
          <div class="rounded-md bg-white p-3 border border-slate-200">
            <div class="text-xs uppercase tracking-wider text-slate-500">Data source</div>
            <div class="text-sm font-semibold text-slate-900">JSON</div>
            <div class="text-[11px] text-slate-500 mt-1">${safe(meta.createdAt)}</div>
          </div>
        </div>
      `;

      const contestBlocks = contests
        .map((c) => {
          const rows = c.options
            .map(
              (o) => `
              <tr class="border-t border-slate-100">
                <td class="py-2 pr-3 text-slate-900">${safe(o.candidateName)}</td>
                <td class="py-2 pr-3 text-right font-mono text-slate-900">${Number(o.votes || 0).toLocaleString()}</td>
                <td class="py-2 text-right text-xs text-slate-500">${safe(o.reportingStatus)}</td>
              </tr>
            `
            )
            .join("");

          return `
            <details class="rounded-md border border-slate-200 bg-white">
              <summary class="cursor-pointer select-none px-3 py-3 flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-sm font-semibold text-slate-900 leading-tight">${safe(c.contestName)}</div>
                  <div class="mt-0.5 text-xs text-slate-600">
                    voteFor: ${safe(c.voteFor)} · total votes: <span class="font-mono">${Number(c.totalVotes || 0).toLocaleString()}</span>
                  </div>
                </div>
                <div class="shrink-0 text-xs font-semibold text-slate-600">${safe(c.reportingStatus)}</div>
              </summary>

              <div class="px-3 pb-3">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-xs uppercase tracking-wider text-slate-500">
                      <th class="py-2 text-left font-semibold">Option</th>
                      <th class="py-2 text-right font-semibold">Votes</th>
                      <th class="py-2 text-right font-semibold">Status</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </details>
          `;
        })
        .join('<div class="h-3"></div>');

      elReport.innerHTML = header + summary + contestBlocks;
    }

    // =========================
    // Load elections
    // =========================
    async function loadAll() {
      if (!elSelect || !elReport) return;

      elSelect.innerHTML = `<option value="">Loading…</option>`;

      const loads = await Promise.allSettled(
        ELECTION_SOURCES.map(async (src) => {
          const res = await fetch(src.url, { cache: "no-store" });
          if (!res.ok) throw new Error(`Failed ${src.url}: HTTP ${res.status}`);
          const data = await res.json();
          indexElectionJson(data, src);
          return src.id;
        })
      );

      const okIds = loads
        .filter((r) => r.status === "fulfilled")
        .map((r) => r.value)
        .sort()
        .reverse();

      if (!okIds.length) {
        elSelect.innerHTML = `<option value="">No data</option>`;
        elReport.innerHTML =
          `<div class="text-red-700">Could not load election JSON files. Check that they exist in the built site output.</div>`;
        return;
      }

      elSelect.innerHTML = okIds
        .map((id) => {
          const m = ELECTION_META.get(id);
          const label = m ? `${parseDate(m.electionDate)} · ${m.electionName}` : id;
          return `<option value="${id}">${label}</option>`;
        })
        .join("");

      // Change election selection -> re-render if a precinct is selected
      elSelect.addEventListener("change", () => {
        const last = window.UCD_LAST_SELECTED_PRECINCT || "";
        if (last) renderForPrecinct(last);
      });

      // If map already selected something before data finished loading
      const last = window.UCD_LAST_SELECTED_PRECINCT || "";
      if (last) renderForPrecinct(last);
      else elReport.innerHTML = "Select a precinct to populate this report.";
    }

    // expose API for the map script
    window.UCDReports = { renderForPrecinct };

    loadAll();
  })();
</script>
